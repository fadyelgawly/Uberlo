import { useLayoutEffect } from 'react';
import useEventCallback from './useEventCallback';
var targetMap = new WeakMap();
var observer;

function getObserver(Observer) {
  // eslint-disable-next-line no-return-assign
  return observer = observer || new Observer(function (entries) {
    entries.forEach(function (entry) {
      var handler = targetMap.get(entry.target);
      if (handler) handler(entry);
    });
  });
}

export default function useObserver(MyObserver, element, handler, leadingHandler) {
  var handlerCallback = useEventCallback(handler);
  useLayoutEffect(function () {
    if (!element) return;
    getObserver(MyObserver).observe(element);
    if (leadingHandler) leadingHandler(element);
    targetMap.set(element, handlerCallback);
    return function () {
      targetMap.delete(element);
    };
  }, [element]);
}